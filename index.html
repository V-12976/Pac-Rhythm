<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pac-Rhythm</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" />
  <link rel="stylesheet" href="./styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/jszip@3/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
</head>

<body>
  <div class="app">
    <header class="app-bar">
      <div class="brand">
        <div class="brand-mark"></div>
        <div>
          <div class="app-title">Pac-Rhythm</div>
          <div class="app-subtitle">轨道闪避节奏</div>
        </div>
      </div>
      <nav class="app-nav">
        <button class="nav-button active" data-view="homeView">首页</button>
        <button class="nav-button" data-view="gameSetupView">开始游戏</button>
        <button class="nav-button" data-view="editorView">编辑器</button>
      </nav>
    </header>

    <main class="views">
      <section class="view active" id="homeView">
        <div class="hero-card">
          <div class="hero-copy">
            <div class="hero-title">沉浸式轨道闪避节奏对决</div>
            <div class="hero-subtitle">
              以吃豆人为主题，三轨道闪避、强化道具与连击计分
            </div>
            <div class="hero-actions">
              <button class="filled-button" id="primaryStart">开始游戏</button>
              <button class="tonal-button" id="primaryEditor">进入编辑器</button>
            </div>
          </div>
          <div class="hero-visual">
            <div class="hero-ring"></div>
            <div class="hero-ring second"></div>
            <div class="hero-pacman"></div>
          </div>
        </div>
        <div class="feature-grid">
          <div class="feature-card">
            <div class="feature-title">三轨闪避</div>
            <div class="feature-text">W/S/X 逐轨移动，避免幽灵撞击</div>
          </div>
          <div class="feature-card">
            <div class="feature-title">大力丸强化</div>
            <div class="feature-text">10 秒内可反吃幽灵，连击加成翻倍</div>
          </div>
          <div class="feature-card">
            <div class="feature-title">本地谱面</div>
            <div class="feature-text">内置编辑器，保存曲目随时演奏</div>
          </div>
        </div>
      </section>

      <section class="view" id="gameSetupView">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">选择曲目</div>
              <div class="card-subtitle">从已保存的谱面中开始对决</div>
            </div>
            <button class="tonal-button" id="openEditorFromSetup">创建新曲目</button>
          </div>
          <div class="song-list" id="songList"></div>
        </div>
        <div class="card game-launch">
          <div>
            <div class="card-title" id="selectedSongTitle">未选择曲目</div>
            <div class="card-subtitle" id="selectedSongMeta">请选择一个谱面</div>
          </div>
          <button class="filled-button" id="launchGameButton" disabled>开始演奏</button>
        </div>
      </section>

      <section class="view" id="gameView">
        <!-- Top bar: song info + status -->
        <div class="game-topbar">
          <div class="game-topbar-left">
            <div class="game-song-title" id="playingTitle">演奏中</div>
            <div class="game-song-meta" id="playingMeta">节奏准备</div>
          </div>
          <div class="game-status-chip" id="statusText">按空格开始</div>
          <div class="game-topbar-right">
            <button class="game-control-btn primary" id="startButton">▶ 开始</button>
            <button class="game-control-btn" id="pauseButton">⏸ 暂停</button>
            <button class="game-control-btn ghost-btn" id="resetButton">↺ 重置</button>
          </div>
        </div>

        <!-- Main game area: HUD left | Canvas center | Camera right -->
        <div class="game-main">
          <!-- Left HUD Panel -->
          <div class="game-hud-panel">
            <div class="hud-block hud-score">
              <div class="hud-label">分数</div>
              <div class="hud-value" id="scoreValue">0</div>
            </div>
            <div class="hud-block hud-combo">
              <div class="hud-label">连击</div>
              <div class="hud-value" id="comboValue">0</div>
            </div>
            <div class="hud-block hud-life">
              <div class="hud-label">生命</div>
              <div class="hud-hearts" id="lifeValue">❤❤❤</div>
            </div>
            <div class="hud-block hud-pellet">
              <div class="hud-label">豆子</div>
              <div class="hud-value" id="pelletValue">0</div>
            </div>
            <div class="hud-block hud-power">
              <div class="hud-label">强化</div>
              <div class="hud-value" id="powerValue">无</div>
            </div>
          </div>

          <!-- Center: Game canvas -->
          <div class="game-stage">
            <canvas id="gameCanvas" width="960" height="360"></canvas>
            <!-- Game Over Overlay -->
            <div class="modal hidden" id="gameOverModal">
              <div class="modal-card">
                <div class="modal-icon">🎮</div>
                <div class="modal-title" id="gameOverTitle">对决结束</div>
                <div class="modal-reason" id="gameOverReason">原因</div>
                <div class="modal-score-big">
                  <span class="modal-score-label">最终得分</span>
                  <span class="modal-score-value" id="gameOverScore">0</span>
                </div>
                <div class="modal-actions">
                  <button class="game-control-btn primary" id="restartButton">🔄 重新开始</button>
                  <button class="game-control-btn" id="backToEditorButton">✏️ 返回编辑器</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Camera/Pose panel -->
          <div class="game-pose-panel">
            <div class="pose-preview-game">
              <video id="poseVideo" playsinline></video>
              <canvas id="poseCanvas"></canvas>
              <div class="pose-overlay-label" id="poseStatus">手势：关闭</div>
            </div>
            <div class="pose-compact-controls">
              <select id="cameraSelect" class="pose-select-compact"></select>
              <div class="pose-btns-row">
                <label class="toggle-compact">
                  <input type="checkbox" id="gestureStartToggle" />
                  <span>手势</span>
                </label>
                <button class="pose-btn-compact" id="refreshCameraButton">⟳</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="editorView">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">谱面编辑器</div>
              <div class="card-subtitle">创建与保存专属节奏轨道</div>
            </div>
            <div class="editor-actions">
              <input id="songNameInput" placeholder="曲目名称" />
              <label class="file-input">
                <span>音频</span>
                <input id="audioInput" type="file" accept="audio/*" />
              </label>
              <div class="audio-name" id="audioName">未选择音频</div>
            </div>
          </div>
          <div class="editor-toolbar">
            <div class="toolbar-group">
              <div class="group-label">文件</div>
              <button class="outlined-button" id="newSongButton">新建</button>
              <button class="filled-button" id="saveSongButton">保存</button>
              <select id="songSelect"></select>
              <button class="outlined-button" id="loadSongButton">加载</button>
            </div>
            <div class="toolbar-group">
              <div class="group-label">播放</div>
              <button class="outlined-button" id="playAudioButton">播放</button>
              <button class="text-button" id="stopAudioButton">停止</button>
            </div>
            <div class="toolbar-group">
              <div class="group-label">BPM</div>
              <label class="tool">
                BPM
                <input id="bpmInput" type="number" min="60" max="200" value="120" />
              </label>
              <div class="bpm-status" id="bpmStatus">等待音频</div>
            </div>
            <div class="toolbar-group">
              <div class="group-label">工具</div>
              <select id="toolSelect">
                <option value="pellet">豆子</option>
                <option value="power">大力丸</option>
                <option value="ghost">幽灵</option>
                <option value="erase">擦除</option>
              </select>
            </div>
            <div class="toolbar-group">
              <div class="group-label">自动谱面</div>
              <select id="difficultySelect">
                <option value="easy">简单</option>
                <option value="normal" selected>普通</option>
                <option value="hard">困难</option>
                <option value="expert">专家</option>
              </select>
              <button class="filled-button" id="autoGenerateButton">🎵 生成谱面</button>
            </div>
          </div>
          <div class="recorder-panel">
            <div class="recorder-header">
              <div>
                <div class="card-title">录制路径</div>
                <div class="card-subtitle">Q 开始/暂停/继续 · 暂停时 ←→ 调整位置 (Shift±5s) · Esc 停止</div>
              </div>
            </div>
            <div class="timeline-container">
              <canvas id="recordCanvas" height="220"></canvas>
            </div>
          </div>
          <div class="editor-panel">
            <div class="card-title">谱面时间轴</div>
            <div class="card-subtitle">点击放置豆子/大力丸/幽灵，按工具切换</div>
            <div class="timeline-container">
              <canvas id="editorCanvas" height="220"></canvas>
            </div>
          </div>
          <div class="panel-footer">
            <span class="hint">W 上轨道 / S 中轨道 / X 下轨道（相邻移动）</span>
          </div>
          <textarea id="chartArea" spellcheck="false"></textarea>
        </div>
      </section>
    </main>
  </div>

  <script src="./main.js"></script>
</body>

</html>